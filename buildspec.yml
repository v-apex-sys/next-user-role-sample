version: 0.2
phases:
  install:
    runtime-versions:
      # https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/available-runtimes.html
      nodejs: 18
    commands:
      - echo install started on `date`
      - node -e "console.log('Running Node.js ' + process.version)"
      - yarn install
  build:
    commands:
      - echo Build started on `date`
      - mkdir ./.env
      - echo export default { API_URL:\'$API_URL\' } >> ./.env/local.js
      - echo export default { API_URL:\'$API_URL\' } >> ./.env/development.js
      - echo export default { API_URL:\'$API_URL\' } >> ./.env/production.js
      - cat ./.env/local.js
      - echo export default { "type":"module" } >> ./package.json
      - yarn export
  post_build:
    commands:
      - pwd
      - ls -a
#      - aws s3 sync ./build s3://### --delete --acl public-read
#      - aws cloudfront create-invalidation --distribution-id ###ID### --paths "/*"
artifacts:
  files:
    - ./.next/**/*
    - ./appspec.yml
    # 以下はSSRに必要なセット
    - node_modules/**/*
    - next.config.js
    - .env/**/*
    - scripts/**/*
    - package.json
# cache:
#   paths:
#     - 'node_modules/**/*' # Cache `node_modules` for faster `yarn` or `npm i`
#     - '.next/cache/**/*' # Cache Next.js for faster application rebuilds
